pipeline {
    agent {
        label 'ec2'
    }

    stages {
        stage ('Build') {
            steps {
                echo 'Building DHIS2 ...'
                script {
                    withMaven {
                        sh 'mvn clean install -f dhis-2/pom-full.xml -Pjdk11 --update-snapshots'
                    }
                }
            }
        }

        stage ('Sync WAR') {
            steps {
                echo 'Syncing WAR ...'
                sh 'curl "https://raw.githubusercontent.com/dhis2/dhis2-server-setup/master/ci/scripts/sync-war-s3.sh" -o sync-war-s3.sh'
                sh 'chmod +x sync-war-s3.sh'
                sh './sync-war-s3.sh dev'
            }
        }

        stage ('Update Play Instance') {
            steps {
                echo 'Updating Play Instance ...'
                sh 'curl "https://raw.githubusercontent.com/dhis2/dhis2-server-setup/master/ci/scripts/update-play-instance.sh" -o update-play-instance.sh'
                sh 'chmod +x update-play-instance.sh'
                sh './update-play-instance.sh dev'
            }
        }
    }

    post {
        success {
            archiveArtifacts artifacts: 'dhis-2/dhis-web/dhis-web-portal/target/dhis.war'
        }
    }
}
